<mat-toolbar color="primary" class="dashboard-toolbar">
  <span class="toolbar-title">ADMIN DASHBOARD</span>
  <span class="spacer"></span>
  <button mat-icon-button (click)="onLogout()">
    <mat-icon>logout</mat-icon>
  </button>
</mat-toolbar>
@if (isLoading) {
  <div class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando datos del administrador...</p>
  </div>
} @else {
  <div class="dashboard-container">
    <div class="metrics-row">
      <mat-card class="metric-card revenue-card">
        <mat-card-header>
          <mat-card-title>Ingreso Mensual Proyectado</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <h2 class="revenue-value">{{ proyectedRevenue | currency:'EUR':'symbol':'1.2-2' }}</h2> 
        </mat-card-content>
      </mat-card>
    </div>
    <div class="content-row">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Clientes Activos por Paquete</mat-card-title>
        </mat-card-header>
        <mat-card-content class="chart-content">
          @if (pieChartData.datasets[0].data.length > 0) {
            <canvas 
              baseChart 
              [options]="pieChartOptions" 
              [data]="pieChartData" 
              [type]="pieChartType">
            </canvas>
          } @else {
            <p class="empty-chart">No hay datos de paquetes activos para mostrar.</p>
          }
        </mat-card-content>
      </mat-card>
      <mat-card class="table-card">
        <mat-card-header class="table-header">
          <mat-card-title>Gestión de Usuarios</mat-card-title>
          <button mat-flat-button color="accent" (click)="openCreateUserDialog()">
            <mat-icon>person_add</mat-icon>
            Crear Usuario
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="table-responsive">
            <table mat-table [dataSource]="userDataSource" class="full-width-table">
              @for (column of userDisplayedColumns; track column) {
                @if (column === 'actions') {
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Acciones</th>
                    <td mat-cell *matCellDef="let element">
                      <button mat-icon-button color="primary" (click)="openEditUserDialog(element.id)">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="warn" (click)="confirmDelete(element.id, element.username)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </td>
                  </ng-container>
                } @else {
                  <ng-container [matColumnDef]="column">
                    <th mat-header-cell *matHeaderCellDef>{{ column | titlecase }}</th>
                    <td mat-cell *matCellDef="let element">{{ element[column] }}</td>
                  </ng-container>
                }
              }
              <tr mat-header-row *matHeaderRowDef="userDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: userDisplayedColumns"></tr>
              @if (userDataSource.length === 0) {
                <tr class="mat-row empty-row">
                  <td class="mat-cell" [attr.colspan]="userDisplayedColumns.length">
                    No se encontraron usuarios.
                  </td>
                </tr>
              }
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    <mat-divider></mat-divider>
    <mat-card class="client-table-card">
      <mat-card-header>
        <mat-card-title>Gestión y Listado de Clientes</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="filter-controls">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Filtrar por Paquete</mat-label>
            <mat-select [(ngModel)]="packageFilter" (selectionChange)="applyClientFilters()">
              <mat-option [value]="null">Todos los Paquetes</mat-option>
              @for (pkg of packageOptions; track pkg) {
                <mat-option [value]="pkg">{{ pkg }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Filtrar por Estado</mat-label>
            <mat-select [(ngModel)]="activeFilter" (selectionChange)="applyClientFilters()">
              <mat-option [value]="null">Todos</mat-option>
              <mat-option [value]="true">Activo</mat-option>
              <mat-option [value]="false">Inactivo</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="table-responsive">
          <table mat-table [dataSource]="clientDataSource" class="full-width-table">
            @for (column of clientDisplayedColumns; track column) {
              <ng-container [matColumnDef]="column">
                <!-- ===== HEADER ===== -->
                <th mat-header-cell *matHeaderCellDef>
                  @if (column === 'cif') {
                    CIF
                  } @else if (column === 'servicePackage') {
                    Paquete
                  } @else if (column === 'companyName') {
                    Nombre
                  } @else if (column === 'direction') {
                    Dirección
                  } @else if (column === 'active') {
                    Activo
                  } @else {
                    {{ column | titlecase }}
                  }
                </th>
                <!-- ===== CELDAS ===== -->
                <td mat-cell *matCellDef="let element">
                @if (column === 'active') {
                  <mat-icon [color]="element.active ? 'primary' : 'warn'">
                    {{ element.active ? 'check_circle' : 'cancel' }}
                  </mat-icon>
                  } @else {
                    {{ element[column] || '—' }}
                  }
                </td>
              </ng-container>
            }
            <tr mat-header-row *matHeaderRowDef="clientDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: clientDisplayedColumns"></tr>
            @if (clientDataSource.length === 0) {
              <tr class="mat-row empty-row">
                <td class="mat-cell" [attr.colspan]="clientDisplayedColumns.length">
                  No se encontraron clientes con los filtros aplicados.
                </td>
              </tr>
            }
          </table>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="report-log-card">
      <mat-card-header>
          <mat-card-title>Historial de Reportes Periódicos (PDF)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
          <div class="table-responsive">
              <table mat-table [dataSource]="reportLogDataSource" class="full-width-table">

                  <ng-container matColumnDef="date">
                      <th mat-header-cell *matHeaderCellDef>Fecha de Generación</th>
                      <td mat-cell *matCellDef="let element">{{ element.generationDate | date:'medium' }}</td>
                  </ng-container>

                  <ng-container matColumnDef="type">
                      <th mat-header-cell *matHeaderCellDef>Tipo</th>
                      <td mat-cell *matCellDef="let element">{{ element.reportType }}</td>
                  </ng-container>

                  <ng-container matColumnDef="emailSent">
                      <th mat-header-cell *matHeaderCellDef>Email Enviado</th>
                      <td mat-cell *matCellDef="let element">
                          <mat-icon [color]="element.emailSent ? 'primary' : 'warn'">
                              {{ element.emailSent ? 'check_circle' : 'warning' }}
                          </mat-icon>
                      </td>
                  </ng-container>

                  <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef>Acciones</th>
                      <td mat-cell *matCellDef="let element">
                          <button mat-icon-button color="accent" (click)="openPdf(element.id)">
                              <mat-icon>picture_as_pdf</mat-icon>
                          </button>
                      </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="reportLogDisplayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: reportLogDisplayedColumns"></tr>

                  @if (reportLogDataSource.length === 0) {
                      <tr class="mat-row empty-row">
                          <td class="mat-cell" [attr.colspan]="reportLogDisplayedColumns.length">
                              No se han generado reportes aún.
                          </td>
                      </tr>
                  }
              </table>
          </div>
      </mat-card-content>
    </mat-card>
  </div>
}